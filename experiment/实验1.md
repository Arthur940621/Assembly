# 实验1 查看 `CPU` 和内存，用机器指令和汇编指令编程

## 预备知识: `Debug` 的使用

`Debug` 是实模式程序的调试工具。使用它可以查看 `CPU` 各种寄存器中的内容、内存的情况和在机器码级跟踪程序的运行。

- `R` 命令查看、改变 `CPU` 寄存器的内容
- `D` 命令查看内存中的内容
- `E` 命令改写内存中的内容
- `U` 命令将内存中的机器指令翻译成汇编指令
- `T` 命令执行一条机器指令
- `A` 命令以汇编指令的格式在内存中写入一条机器指令

### 用 `R` 命令查看、改变 `CPU` 寄存器的内容

![025]()

注意 `CS` 和 `IP` 的值，`CS=073F`，`IP=0100`，也就是说，内存 `073F:0100` 处的指令为 `CPU` 当前要读取、执行的指令。

在所有寄存器的下方，`Debug` 还列出了 `CS:IP` 所指向的内存单元处所存放的机器码，并将它翻译为汇编指令。可以看到，`CS:IP` 所指向的内存单元为 `073F:0100`，此处存放的机器码为 `0000`，对应的汇编指令为 `ADD [BX+SI],ALR`。


`Debug` 输出的右下角还有一个信息: `DS:0048=CD`。

还可以用 `R` 命令来改变寄存器中的内容，比如 `AX` 中的值，可用 `R` 命令后加寄存器名，再输入要写入的数据后，即完成了对 `AX` 中内容的修改:

![026]()


同理，用 `R` 命令将 `IP` 修改为 `200`，将 `CS` 修改为 `FF00`，则 `CS:IP` 指向 `FF00:0200`，此处存放的机器码为 `0000`:

![027]()

### 用 `D` 命令查看内存中的内容

`D` 命令可以查看内存中的内容，`D` 命令的格式较多。

如果想知道内存 `10000H` 处的内容，可以用 `D 段地址:偏移地址` 的格式来查看，首先将这个地址表示为 `段地址:偏移地址` 的格式，可以是 `1000:0`，然后用 `D 1000:0` 列出 `1000:0` 处的内容。


使用 `D 段地址:偏移地址` 的格式，`Debug` 将列出从指定内存单元开始的 `128` 个内存单元的内容。在使用 `D 1000:0` 后，`Debug` 列出了`1000:0~1000:7F` 中的内容:

![028]()

- 中间是从指定地址开始的 `128` 个内存单元的内容，用十六进制的格式输出，每行的输出从 `16` 的整数倍的地址开始，最多输出 `16` 个单元的内容。内存`1000:0` 单元中的内容是 `00H`，内存 `1000:1` 单元中的内容是 `00H`，内存 `1000:0~1000:F` 中的内容都在第一行。内存 `1000:10~1000:1F` 中的内容都在第二行。注意在每行的中间有一个 `-`，它将每行的输出分为两部分，这样便于查看。比如，要想从图中找出 `1000:6B` 单元中内容，可以从 `1000:60` 找到行，`-` 前面是 `1000:60~1000:67` 的 `8` 个单元，后面是 `1000:68~1000:6F` 的 `8` 个单元，这样我们就可以从 `1000:68` 单元向后数 `3` 个单元，找到 `1000:6B` 单元
- 左边是每行的起始地址
- 右边是每个内存单元中的数据对应的可显示的 `ASCII` 码字符。没有对应可显示的 `ASCII` 字符，`Debug` 就用 `.` 来代替

我们使用 `D 1000:9` 查看 `1000:9` 处的内容，`Debug` 从 `1000:9` 开始显示，一直到 `1000:88`，一共 `128` 个字节。第一行中的 `1000:0~1000:8` 单元中的内容不显示:

![029]()

在一进入 `Debug` 后，用 `D` 命令直接查看，将列出 `Debug` 预设的地址处的内容:

![030]()

在使用 `D 段地址:偏移地址` 之后，接着使用 `D` 命令，可列出后续的内容:

![031]()

也可以指定 `D` 命令的查看范围，此时采用 `D 段地址:起始偏移地址 结尾偏移地址` 的格式。比如要看 `1000:0~1000:9` 中的内容，可以用 `D 1000:0 9` 实现:

![032]()

如果我们仅想查看内存单元 `10000H` 中的内容，可以用下图中的任何一种方法看到:

![033]()

### 用 `E` 命令改写内存中的内容

可以使用 `E` 命令来改写内存中的内容，比如，要将内存 `1000:0~1000:9` 单元中的内容分别写为 `0~9`，可以用 `E 起始地址 数据 数据 数据......` 的格式来进行:

![034]()

也可以采用提问的方式来一个一个地改写内存中的内容:

![035]()

- 输入 `E 段地址:偏移地址`，按 `Enter` 键。
- `Debug` 显示起始地址，和第一单元的原始内容，然后光标停在 . 的后面提示输入想要写入的数据，此时可以有两个选择:
  - 其一为输入数据，然后按空格键，即用输入的数据改写当前的内存单元
  - 其二为不输入数据，直接按空格键，则不对当前内存单元进行改写
- 当前单元处理完成后，`Debug` 将接着显示下一个内存单元的原始内容，并提示进行修改
- 所有希望改写的内存单元改写完毕后，按 `Enter` `键，E` 命令操作结束

### 用 `E` 命令向内存中写入机器码，用 `U` 命令查看内存中机器码的含义，用 `T` 命令执行内存中的机器码

用 `E` 命令向内存中写入字符串:

![036]()

机器码也是数据，可以用 `E` 命令将机器码写入内存。比如我们要从内存 `1000:0` 单元开始写入这样一段机器码:

|机器码|对应的汇编指令|
|-|-|
|b80100|mov ax,0001|
|b90200|mov cx,0002|
|01c8|add ax,cx|

首先用 `E` 命令向从 `1000:0` 开始的内存单元中写入了 `8` 个字节的机器码，然后用 `D` 命令查看内存 `1000:0~1000:1f` 中的数据，最后用 `U` 命令查看从 `1000:0` 开始的内存单元中的机器指令和它们所对应的汇编指令:

![037]()

`U` 命令的显示输出分为 `3` 部分，每一条机器指令的地址、机器指令、机器指令所对应的汇编指令:

- `1000:0` 处存放的是写入的机器码 `b80100` 所组成的机器指令，对应的汇编指令是 `mov ax,1`
- `1000:3` 处存放的是写入的机器码 `b90200` 所组成的机器指令，对应的汇编指令是 `mov cx,2`
- `1000:6` 处存放的是写入的机器码 `01c8` 所组成的机器指令，对应的汇编指令是 `add ax,cx`

内存中的数据和代码没有任何区别，关键在于如何解释。

使用 `Debug` 的 `T` 命令可以执行一条或多条指令，简单地使用 `T` 命令，可以执行 `CS:IP` 指向的指令:

![038]()

用 `R` 命令查看 `CPU` 中寄存器的状态，可以看到，`CS=073FH`、`IP=0100H`，指向内存 `073F:0100`，若要用 `T` 命令控制 `CPU` 执行我们写到 `1000:0` 的指令，必须先让 `CS:IP` 指向 `1000:0A`，接着用 `R` 命令修改 `CS`、`IP` 中的内容，使 `CS:IP` 指向 `1000:0`。

完成上面的步骤后，就可以使用 `T` 命令来执行写入的指令了。执行 `T` 命令后，`CPU` 执行 `CS:IP` 指向的指令，则 `1000:0` 处的指令 `b80100`（`mov ax,0001`）得到执行，指令执行后，`Debug` 显示输出 `CPU` 中寄存器的状态。

注意，指令执行后，`AX` 中的内容被改写为 `1`，`IP` 改变为 `IP+3`（因为 `mov ax,0001` 的指令长度为 `3` 个字节），`CS:IP`指向下一条指令。

继续使用 `T` 命令执行下面的指令。

### 用 `A` 命令以汇编指令的形式在内存中写入机器指令

前面使用 `E` 命令写入机器指令，这样做很不方便，最好能直接以汇编指令的形式写入指令。为此，`Debug` 提供了 `A` 命令:

![039]()

首先用 `A` 命令，以汇编语言向从 `1000:0` 开始的内存单元中写入了几条指令，然后用 `D` 命令查看 `A` 命令的执行结果。可以看到，在使用 `A` 命令写入指令时，输入的是汇编指令，`Debug` 将这些汇编指令翻译为对应的机器指令，将它们的机器码写入内存。

## 试验任务

### 使用 `Debug`，将下面的程序段写入内存，逐条执行，观察每条指令执行后 `CPU` 中相关寄存器中内容的变化

|机器码|汇编指令|
|-|-|
|b8 20 4e|mov ax,4E20H|
|05 16 14|add ax,1416H|
|bb 00 20|mov bx,2000H|
|01 d8|add ax,bx|
|89 c3|mov bx,ax|
|01 d8|add ax,bx|
|b8 1a 00|mov ax,001AH|
|bb 26 00|mov bx,0026H|
|00 d8|add al,bl|
|00 dc|add ah,bl|
|00 c7|add bh,al|
|b4 00|mov ah,0|
|00 d8|add al,bl|
|04 9c|add al,9CH|

提示，可用 `E` 命令和 `A` 命令以两种方式将指令写入内存。注意用 `T` 命令执行时，`CS:IP` 的指向。

用 `A` 命令将汇编指令写入内存，并修改 `CS:IP`:

![040]()

用 `U` 命令将机器指令写入内存，并修改 `CS:IP`:

![041]()

用 `T` 命令执行:

![042]()

### 将下面 `3` 条指令写入从 `2000:0` 开始的内存单元中，利用这 `3` 条指令计算 `2` 的 `8` 次方

```
mov ax,1
add ax,ax
jmp 2000:0003
```

`A` 命令写入汇编指令，修改 `CS:IP`，`T` 命令执行:

![043]()

直至 `AX = 100H`:

![044]()

### 查看内存中的内容

`PC` 机主板上的 `ROM` 中写有一个生产日期，在内存 `FFF00H~FFFFFH` 的某几个单元中，请找到这个生产日期并试图改变它。

![045]()

可以看到在最后一行 `FFFF0` 处，`92` 年 `1` 月 `1` 日，如果通过 `E` 命令修改，是无效的。因为这里属于 `ROM` 部分（`C0000~FFFFF`），属于只读区域，写入是无效的。

### 向内存从 `B8100H` 开始的单元中填写数据，如：

```
-E B810:0000 01 01 02 02 03 03 04 04
```

请读者先填写不同的数据，观察产生的现象；再改变填写的地址，观察产生的现象。

![046]()

因为 `A0000~BFFFF` 属于显存地址空间。